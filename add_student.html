<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Student</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { min-height: 100vh; background: #020617; color: white; padding: 40px; display: flex; align-items: center; justify-content: center; }
        .container { width: 100%; max-width: 500px; background: rgba(255,255,255,0.03); border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); padding: 40px; text-align: center; }
        input { width: 100%; padding: 14px; margin: 15px 0; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: white; outline: none; }
        .btn-save { width: 100%; padding: 15px; border-radius: 50px; background: #7f5af0; color: white; border: none; font-weight: 800; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <a href="teacher_dashboard.html" style="color:#7f5af0; text-decoration:none;">‚Üê Back Dashboard</a>
        <h2 id="classHeading" style="margin: 20px 0; font-size: 18px; color: #94a3b8;">New Registration</h2>
        <input type="text" id="reg" placeholder="Enter Reg No ( e.g XX00BXX000 )" oninput="format(this)">
        <input type="text" id="name" placeholder="Enter Student Name">
        <button class="btn-save" id="saveBtn">Save to Database</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyAL_IfQW5X3IuHU7ClkBQhRjTWEceF5Aio",
    authDomain: "attendance-system-123.firebaseapp.com",
    projectId: "attendance-system-123",
    storageBucket: "attendance-system-123.firebasestorage.app",
    messagingSenderId: "592694519186",
    appId: "1:592694519186:web:e4cc56fc44afd137770d4b",
    measurementId: "G-TWE5VVT6ZQ"
  };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global context variables
        const currentClassId = localStorage.getItem('current_class_id');
        let currentClassData = null;

        // Fetch Class Info on Load
        window.onload = async function() {
            if(!currentClassId) {
                alert("No class selected! Redirecting...");
                window.location.href = 'class_management.html';
                return;
            }

            const classRef = ref(db, 'cui_classes/' + currentClassId);
            const snapshot = await get(classRef);
            if(snapshot.exists()) {
                currentClassData = snapshot.val();
                document.getElementById('classHeading').innerText = "Registration for: " + currentClassData.className;
            } else {
                alert("Class not found!");
                window.location.href = 'class_management.html';
            }
        };

        // Reg formatting logic (Same as original)
        window.format = function(el) {
            let v = el.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (v.length >= 10) {
                el.value = v.substring(0,4) + "-" + v.substring(4,7) + "-" + v.substring(7,10);
            }
        }

        // Save logic
        async function save() {
            let r = document.getElementById('reg').value;
            let n = document.getElementById('name').value;
            if(!r || !n) return alert("Empty fields!");

            let students = currentClassData.students || [];
            
            // --- Auto-Present Logic ---
            let existingDates = new Set();
            students.forEach(student => {
                if(student.history) {
                    student.history.forEach(entry => {
                        existingDates.add(entry.date);
                    });
                }
            });

            let autoHistory = [];
            existingDates.forEach(dateStr => {
                autoHistory.push({ date: dateStr, status: 'P' });
            });

            // Add new student
            students.push({ 
                reg: r, 
                name: n, 
                history: autoHistory 
            });

            // Update Firebase
            try {
                const studentsRef = ref(db, `cui_classes/${currentClassId}/students`);
                await set(studentsRef, students);
                
                alert("Student Registered in " + currentClassData.className + " with Auto-Attendance!"); 
                location.reload();
            } catch (error) {
                alert("Error saving: " + error.message);
            }
        }

        document.getElementById('saveBtn').addEventListener('click', save);
    </script>
</body>
</html>